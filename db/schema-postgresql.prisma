datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client"
    output   = "prisma/src/generated/prisma"
}

// --- Enums ---
enum Role {
    ADMIN
    STAFF
    STUDENT
    PARENT
}

enum StaffRole {
    TEACHER
    VICE_PRINCIPAL
    PRINCIPAL
}

enum StudentRole {
    STUDENT
    CLASS_SECRETARY
}

enum GradeLevel {
    TENTH
    ELEVENTH
    TWELFTH
}

enum Major {
    ACCOUNTING
    SOFTWARE_ENGINEERING
}

enum Semester {
    FIRST
    SECOND
}

enum AssessmentType {
    SCHOOLWORK
    HOMEWORK
    QUIZ
    EXAM
    PROJECT
    GROUP_WORK
}

enum AttendanceType {
    PRESENT
    LATE
    ALPHA
    SICK
    PERMISSION
}

enum InfractionCategory {
    LATE
    UNIFORM
    DISCIPLINE
    ACADEMIC
    SOCIAL
    OTHER
}

enum SubjectType {
    GENERAL
    MAJOR
}

// --- Auth & Identity ---

model User {
    id            String    @id @default(cuid())
    name          String
    email         String    @unique
    emailVerified DateTime?
    password      String
    role          Role      @default(STUDENT)

    // Profile Relations
    studentProfile Student?
    teacherProfile Teacher?
    parentProfile  Parent?

    sessions  Session[]
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt

    @@index([email])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- Academic Structure ---

model Classroom {
    id      Int        @id @default(autoincrement())
    grade   GradeLevel
    major   Major
    section String // e.g., "A", "B", "1"

    // One class has one Homeroom Teacher
    homeroomTeacherId String?  @unique
    homeroomTeacher   Teacher? @relation("HomeroomTeacher", fields: [homeroomTeacherId], references: [userId])

    students    Student[]
    assignments TeachingAssignment[]

    @@unique([grade, major, section])
}

model Subject {
    id   Int         @id @default(autoincrement())
    name String      @unique
    type SubjectType

    configId Int
    config   SubjectConfig @relation(fields: [configId], references: [id])

    assignments TeachingAssignment[]
    gradebooks  Gradebook[]
}

model SubjectConfig {
    id            Int          @id @default(autoincrement())
    allowedMajors Major[]
    allowedGrades GradeLevel[]
    type          SubjectType

    subjects Subject[]
}

// --- Profiles ---

model Student {
    id     String @id @default(cuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    studentRole StudentRole @default(STUDENT)

    classId Int?
    class   Classroom? @relation(fields: [classId], references: [id], onDelete: SetNull)

    attendance       Attendance[]
    demerits         DemeritPoint[]
    gradebooks       Gradebook[]
    parent           Parent?
    assessmentScores AssessmentScore[]
}

model Teacher {
    id     String @id @default(cuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    staffRole StaffRole @default(TEACHER)

    // Relation as Homeroom Teacher
    homeroom Classroom? @relation("HomeroomTeacher")

    // Relation as Subject Teacher
    assignments    TeachingAssignment[]
    scoresRecorded AssessmentScore[]
    demeritPoints  DemeritPoint[]
}

model Parent {
    id     String @id @default(cuid())
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    studentId String  @unique
    student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)
}

// --- Teaching & Grading ---

model TeachingAssignment {
    id Int @id @default(autoincrement())

    teacherId String
    teacher   Teacher @relation(fields: [teacherId], references: [userId])

    subjectId Int
    subject   Subject @relation(fields: [subjectId], references: [id])

    classId Int
    class   Classroom @relation(fields: [classId], references: [id])

    totalAssignmentAssigned Int @default(0)

    assessments Assessment[]

    @@unique([teacherId, subjectId, classId])
}

model Gradebook {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [userId])
    subjectId Int
    subject   Subject @relation(fields: [subjectId], references: [id])

    semester Semester

    scores AssessmentScore[]

    @@unique([studentId, subjectId, semester])
}

model Assessment {
    id    Int            @id @default(autoincrement())
    title String
    type  AssessmentType @default(SCHOOLWORK)

    teachingAssignmentId Int
    assignment           TeachingAssignment @relation(fields: [teachingAssignmentId], references: [id], onDelete: Cascade)

    scores AssessmentScore[]

    givenAt DateTime
    dueAt   DateTime

    createdAt DateTime @default(now())
}

model AssessmentScore {
    id Int @id @default(autoincrement())

    assessmentId Int
    assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

    studentId String
    student   Student @relation(fields: [studentId], references: [userId], onDelete: Cascade)

    gradebookId Int
    gradebook   Gradebook @relation(fields: [gradebookId], references: [id], onDelete: Cascade)

    score Int @default(0)

    teacher   Teacher? @relation(fields: [teacherId], references: [userId])
    teacherId String
}

// --- Discipline & Attendance ---

model Attendance {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [userId])

    date DateTime       @default(now()) @db.Date
    type AttendanceType
    note String?

    @@unique([studentId, date])
}

model DemeritPoint {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [userId])

    points      Int
    category    InfractionCategory
    description String
    date        DateTime           @db.Date

    recordedById String
    teacher      Teacher @relation(fields: [recordedById], references: [userId])
}

model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@id([identifier, token])
}
